<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GenAI Accounting Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold text-center mb-8 text-gray-800">GenAI Accounting Management</h1>
        
        <!-- Configuration -->
        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-8">
            <div class="flex">
                <div class="ml-3">
                    <p class="text-sm text-yellow-700">
                        <strong>Configuration:</strong> Please replace API_BASE with your actual API Gateway URL after deployment.
                    </p>
                </div>
            </div>
        </div>

        <!-- Upload Section -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4">Upload Receipt</h2>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Select Receipt File</label>
                    <input type="file" id="fileInput" accept="image/*,.pdf" 
                           class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">OCR Text (Optional)</label>
                    <textarea id="ocrText" rows="4" 
                              placeholder="Paste OCR text here if you have it, or leave empty..."
                              class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>
                
                <button onclick="upload()" id="uploadBtn"
                        class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed">
                    Upload & Categorize
                </button>
            </div>
        </div>

        <!-- Results Section -->
        <div id="resultsSection" class="bg-white rounded-lg shadow-md p-6 mb-8 hidden">
            <h2 class="text-xl font-semibold mb-4">Upload Results</h2>
            <pre id="results" class="bg-gray-100 p-4 rounded text-sm overflow-auto"></pre>
        </div>

        <!-- KPIs Section -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-700">Total Expenses</h3>
                <p id="totalExpense" class="text-2xl font-bold text-blue-600">$0.00</p>
            </div>
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-700">Receipt Count</h3>
                <p id="receiptCount" class="text-2xl font-bold text-green-600">0</p>
            </div>
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-700">Avg per Receipt</h3>
                <p id="avgPerReceipt" class="text-2xl font-bold text-yellow-600">$0.00</p>
            </div>
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-700">Top Category</h3>
                <p id="topCategory" class="text-2xl font-bold text-purple-600">None</p>
            </div>
        </div>

        <!-- Chart Section -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold">Spend by Category</h2>
                <button onclick="loadSummary()" id="refreshBtn"
                        class="bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                    Refresh Summary
                </button>
            </div>
            <div class="relative" style="height: 400px;">
                <canvas id="spendChart"></canvas>
            </div>
        </div>

        <!-- Loading Spinner -->
        <div id="loadingSpinner" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
            <div class="bg-white p-4 rounded-lg">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div>
                <p class="mt-2 text-center">Processing...</p>
            </div>
        </div>
    </div>

    <script>
        // Configuration - REPLACE WITH YOUR ACTUAL API GATEWAY URL
        const API_BASE = "<<<REPLACE_WITH_API_URL>>>";
        
        let chart = null;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadSummary();
        });

        async function upload() {
            const fileInput = document.getElementById('fileInput');
            const ocrText = document.getElementById('ocrText').value;
            const uploadBtn = document.getElementById('uploadBtn');
            const resultsSection = document.getElementById('resultsSection');
            const results = document.getElementById('results');

            if (!fileInput.files[0]) {
                alert('Please select a file');
                return;
            }

            // Show loading
            showLoading(true);
            uploadBtn.disabled = true;

            try {
                // Convert file to base64
                const file = fileInput.files[0];
                const base64 = await fileToBase64(file);

                const payload = {
                    file_base64: base64.split(',')[1], // Remove data:image/jpeg;base64, prefix
                    filename: file.name,
                    ocr_text: ocrText
                };

                const response = await fetch(`${API_BASE}/classify`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (response.ok) {
                    results.textContent = JSON.stringify(data, null, 2);
                    resultsSection.classList.remove('hidden');
                    
                    // Refresh summary after successful upload
                    await loadSummary();
                    
                    // Clear form
                    fileInput.value = '';
                    document.getElementById('ocrText').value = '';
                } else {
                    throw new Error(data.error || 'Upload failed');
                }

            } catch (error) {
                console.error('Upload error:', error);
                alert('Upload failed: ' + error.message);
            } finally {
                showLoading(false);
                uploadBtn.disabled = false;
            }
        }

        async function loadSummary() {
            const refreshBtn = document.getElementById('refreshBtn');
            
            try {
                refreshBtn.disabled = true;
                refreshBtn.textContent = 'Loading...';

                const response = await fetch(`${API_BASE}/summary`);
                const data = await response.json();

                if (response.ok) {
                    updateKPIs(data.kpis);
                    updateChart(data.summary);
                } else {
                    throw new Error(data.error || 'Failed to load summary');
                }

            } catch (error) {
                console.error('Summary error:', error);
                // Don't alert for summary errors, just log them
                console.warn('Could not load summary data');
            } finally {
                refreshBtn.disabled = false;
                refreshBtn.textContent = 'Refresh Summary';
            }
        }

        function updateKPIs(kpis) {
            document.getElementById('totalExpense').textContent = `$${kpis.total_expense.toFixed(2)}`;
            document.getElementById('receiptCount').textContent = kpis.receipt_count;
            document.getElementById('avgPerReceipt').textContent = `$${kpis.avg_per_receipt.toFixed(2)}`;
            document.getElementById('topCategory').textContent = kpis.top_category;
        }

        function updateChart(summary) {
            const ctx = document.getElementById('spendChart').getContext('2d');
            
            if (chart) {
                chart.destroy();
            }

            const labels = summary.map(item => item.category);
            const data = summary.map(item => item.total);
            const colors = [
                '#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6',
                '#EC4899', '#14B8A6', '#F97316', '#84CC16', '#6366F1'
            ];

            chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Total Spending ($)',
                        data: data,
                        backgroundColor: colors.slice(0, labels.length),
                        borderColor: colors.slice(0, labels.length),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toFixed(2);
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': $' + context.parsed.y.toFixed(2);
                                }
                            }
                        }
                    }
                }
            });
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        function showLoading(show) {
            const spinner = document.getElementById('loadingSpinner');
            if (show) {
                spinner.classList.remove('hidden');
            } else {
                spinner.classList.add('hidden');
            }
        }
    </script>
</body>
</html>